name: Sync Tools Files

on:
  schedule:
    # æ¯å‘¨ä¸€ UTC 00:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´å‘¨ä¸€æ—©ä¸Š8ç‚¹)
    - cron: '0 0 * * 1'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-danmaku-engine:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download latest danmaku.min.js
      run: |
        mkdir -p tools
        curl -L -o tools/danmaku.min.js \
          "https://raw.githubusercontent.com/weizhenye/Danmaku/master/dist/danmaku.min.js"
        
        # è·å–ä¸Šæ¸¸ç‰ˆæœ¬ä¿¡æ¯
        UPSTREAM_VERSION=$(curl -s "https://api.github.com/repos/weizhenye/Danmaku/commits/master" | jq -r '.sha[:7]')
        echo "UPSTREAM_VERSION=$UPSTREAM_VERSION" >> $GITHUB_ENV
        echo "ä¸Šæ¸¸ç‰ˆæœ¬: $UPSTREAM_VERSION"

    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet tools/danmaku.min.js 2>/dev/null; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "å¼¹å¹•å¼•æ“æ— æ›´æ–°"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°å¼¹å¹•å¼•æ“æ›´æ–°"
        fi

    - name: Create Pull Request
      if: steps.check_changes.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore(tools): åŒæ­¥å¼¹å¹•å¼•æ“ danmaku.min.js (${{ env.UPSTREAM_VERSION }})"
        title: "ğŸ”„ åŒæ­¥å¼¹å¹•å¼•æ“æ›´æ–° (${{ env.UPSTREAM_VERSION }})"
        body: |
          ## è‡ªåŠ¨åŒæ­¥æ›´æ–°
          
          æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼ŒåŒæ­¥ä¸Šæ¸¸å¼¹å¹•å¼•æ“æ›´æ–°ã€‚
          
          **ä¸Šæ¸¸ä»“åº“**: [weizhenye/Danmaku](https://github.com/weizhenye/Danmaku)
          **ä¸Šæ¸¸ç‰ˆæœ¬**: `${{ env.UPSTREAM_VERSION }}`
          
          ### å˜æ›´å†…å®¹
          - æ›´æ–° `tools/danmaku.min.js` åˆ°æœ€æ–°ç‰ˆæœ¬
          
          ---
          *è¯·æ£€æŸ¥æ›´æ–°å†…å®¹ååˆå¹¶æ­¤ PR*
        branch: auto-sync/danmaku-engine
        delete-branch: true
        labels: |
          dependencies
          automated

